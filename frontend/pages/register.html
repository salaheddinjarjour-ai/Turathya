<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/png" href="../assets/images/Beigelogo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - TURATHYA</title>

    <script>
        (function () {
            const lang = localStorage.getItem('lang') || 'ar';
            const isAr = lang === 'ar';
            document.documentElement.lang = lang;
            document.documentElement.dir = isAr ? 'rtl' : 'ltr';
            document.documentElement.classList.add('i18n-pending');
            if (isAr) document.documentElement.classList.add('rtl');
        })();
    </script>
    <style>
        html.i18n-pending body {
            opacity: 0;
            pointer-events: none;
        }
    </style>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/typography.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages/account.css">
    <style>
        .section {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 80px);
            padding-bottom: 80px;
        }

        .auth-card {
            width: 100%;
            max-width: 450px;
        }
    </style>
    <link rel="stylesheet" href="../css/components/lang-toggle.css">
</head>

<body>
    <div id="site-header"></div>

    <main class="section">
        <div class="container">
            <div class="auth-container">
                <div class="auth-card">
                    <h1 class="text-center mb-8" data-i18n="auth.registerTitle">Create Account</h1>

                    <form id="register-form">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="name" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="email" placeholder="your@email.com" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 8px;">
                                <input type="text" class="form-input" id="country-code" placeholder="+963" required>
                                <input type="tel" class="form-input" id="phone-local" placeholder="944123456" required>
                            </div>
                            <p class="text-xs text-muted mt-2">Enter country code (with +) and local number separately.
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="password" required minlength="8">
                            <p class="text-xs text-muted mt-2">Minimum 8 chars with uppercase, lowercase, number, and
                                special character.</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-input" id="confirm-password" required minlength="8">
                        </div>

                        <div class="form-group" id="otp-group" style="display: none;">
                            <label class="form-label">Verification Code</label>
                            <input type="text" class="form-input" id="otp-code" maxlength="6"
                                placeholder="Enter 6-digit OTP">
                            <p class="text-xs text-muted mt-2">Enter the 6-digit code you received.</p>
                        </div>

                        <div id="register-error" class="form-error" style="display: none;"></div>

                        <button type="submit" class="btn btn-primary btn-lg w-full"
                            data-i18n="auth.registerTitle">Create Account</button>
                    </form>

                    <div style="margin: 1.5rem 0; text-align: center; position: relative;">
                        <span
                            style="background: var(--theme-surface); padding: 0 10px; color: var(--theme-text-muted); position: relative; z-index: 1;">or</span>
                        <div
                            style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--theme-border); z-index: 0;">
                        </div>
                    </div>

                    <button type="button" id="google-register-fallback" class="btn btn-social"
                        aria-label="Continue With Google">
                        <svg class="btn-social-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill="#EA4335"
                                d="M12 10.2v3.9h5.4c-.2 1.2-.9 2.3-1.9 3.1l3 2.3c1.8-1.6 2.8-4 2.8-6.8 0-.6-.1-1.2-.2-1.8H12z" />
                            <path fill="#34A853"
                                d="M6.9 14.3l-.7.5-2.4 1.9C5.4 20 8.5 22 12 22c2.7 0 5-1 6.7-2.6l-3-2.3c-.8.6-2 1-3.7 1-2.8 0-5.1-1.9-5.9-4.5z" />
                            <path fill="#4A90E2"
                                d="M3.8 7.3C3.3 8.3 3 9.4 3 10.5s.3 2.2.8 3.2c0 0 3.1-2.4 3.1-2.4-.2-.4-.3-.8-.3-1.3s.1-.9.3-1.3L3.8 7.3z" />
                            <path fill="#FBBC05"
                                d="M12 5.8c1.5 0 2.8.5 3.9 1.5l2.9-2.9C17 2.7 14.7 2 12 2 8.5 2 5.4 4 3.8 7.3l3.1 2.4c.8-2.6 3.1-4.5 5.9-4.5z" />
                        </svg>
                        <span data-i18n="auth.registerGoogle">Continue With Google</span>
                    </button>
                    <div id="google-register-btn" style="display: none; justify-content: center;"></div>
                    <div id="google-register-error" class="form-error" style="display: none; margin-top: 0.75rem;">
                    </div>

                    <p class="text-center text-sm text-muted mt-6">
                        Already have an account? <a href="login.html" class="text-accent">Login here</a>
                    </p>
                </div>
            </div>
        </div>
    </main>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="../js/utils.js"></script>
    <script src="../js/i18n.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let otpRequested = false;

        function getGoogleClientId() {
            return localStorage.getItem('google_client_id') || window.GOOGLE_CLIENT_ID || '';
        }

        async function handleGoogleCredentialResponse(response) {
            const errorElement = document.getElementById('google-register-error');
            errorElement.style.display = 'none';

            try {
                const result = await authAPI.googleOAuth(response.credential);
                alert('Google account linked successfully! Your account is pending admin approval.');
                if (result?.user?.role === 'admin') {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'account.html';
                }
            } catch (error) {
                errorElement.textContent = error.message || 'Google registration failed. Please try again.';
                errorElement.style.display = 'block';
            }
        }

        function initializeGoogleRegister() {
            const clientId = getGoogleClientId();
            const errorElement = document.getElementById('google-register-error');
            const fallbackBtn = document.getElementById('google-register-fallback');
            const googleBtnContainer = document.getElementById('google-register-btn');

            fallbackBtn.addEventListener('click', () => {
                errorElement.textContent = 'Google login will be available once OAuth is configured.';
                errorElement.style.display = 'block';
            });

            if (!clientId) {
                return;
            }

            if (!window.google?.accounts?.id) {
                errorElement.textContent = 'Google Sign-In script failed to load.';
                errorElement.style.display = 'block';
                return;
            }

            fallbackBtn.style.display = 'none';
            googleBtnContainer.style.display = 'flex';

            window.google.accounts.id.initialize({
                client_id: clientId,
                callback: handleGoogleCredentialResponse
            });

            window.google.accounts.id.renderButton(
                document.getElementById('google-register-btn'),
                {
                    theme: 'outline',
                    size: 'large',
                    text: 'signup_with',
                    width: 320
                }
            );
        }

        // Redirect if already logged in
        const currentUser = getCurrentUser();
        if (currentUser) {
            window.location.href = 'account.html';
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('country-code').value = '+963';
            initializeGoogleRegister();
        });

        function validateRegistrationInput(full_name, email, countryCode, phoneLocal, password, confirmPassword) {
            const sanitizedCountryCodeDigits = (countryCode || '').replace(/\D/g, '');
            const sanitizedLocal = (phoneLocal || '').replace(/\D/g, '');
            const normalizedPhone = `+${sanitizedCountryCodeDigits}${sanitizedLocal}`;
            const phoneRegex = /^\+[0-9]{8,15}$/;
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z\d]).{8,}$/;

            if (!full_name || !email || !countryCode || !phoneLocal || !password || !confirmPassword) {
                throw new Error('Please fill all required fields.');
            }

            if (!phoneRegex.test(normalizedPhone)) {
                throw new Error('Phone number must be 8-15 digits including country code.');
            }

            if (!passwordRegex.test(password)) {
                throw new Error('Password must be at least 8 characters and include uppercase, lowercase, number, and special character.');
            }

            if (password !== confirmPassword) {
                throw new Error('Password confirmation does not match.');
            }

            return normalizedPhone;
        }

        function setRegistrationFieldsDisabled(disabled) {
            document.getElementById('name').disabled = disabled;
            document.getElementById('email').disabled = disabled;
            document.getElementById('country-code').disabled = disabled;
            document.getElementById('phone-local').disabled = disabled;
            document.getElementById('password').disabled = disabled;
            document.getElementById('confirm-password').disabled = disabled;
        }

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const full_name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const countryCode = document.getElementById('country-code').value;
            const phoneLocal = document.getElementById('phone-local').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const otpCode = document.getElementById('otp-code').value;
            const otpGroup = document.getElementById('otp-group');
            const errorElement = document.getElementById('register-error');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = otpRequested ? 'Verifying OTP...' : 'Sending OTP...';
            errorElement.style.display = 'none';

            try {
                const normalizedPhone = validateRegistrationInput(full_name, email, countryCode, phoneLocal, password, confirmPassword);

                if (!otpRequested) {
                    await authAPI.requestRegistrationOtp(email, password, confirmPassword, full_name, normalizedPhone);
                    otpRequested = true;
                    setRegistrationFieldsDisabled(true);
                    otpGroup.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Verify OTP & Create Account';
                    alert('Verification code sent. Enter the 6-digit code to complete registration.');
                    return;
                }

                if (!otpCode || otpCode.length !== 6) {
                    throw new Error('Please enter the 6-digit OTP code.');
                }

                const result = await authAPI.verifyRegistrationOtp(email, otpCode);

                alert('Account created successfully! Your session is active. If your account is pending approval, bidding will be enabled automatically after approval.');
                if (result?.user?.role === 'admin') {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'account.html';
                }
            } catch (error) {
                errorElement.textContent = error.message || 'Registration failed. Please try again.';
                errorElement.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = otpRequested ? 'Verify OTP & Create Account' : 'Create Account';
            }
        });
    </script>
</body>

</html>