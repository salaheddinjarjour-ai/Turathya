<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Lot detail">
    <title id="page-title">Lot - TURATHYA</title>

    <script>
        (function () {
            const lang = localStorage.getItem('lang') || 'ar';
            const isAr = lang === 'ar';
            document.documentElement.lang = lang;
            document.documentElement.dir = isAr ? 'rtl' : 'ltr';
            document.documentElement.classList.add('i18n-pending');
            if (isAr) document.documentElement.classList.add('rtl');
        })();
    </script>
    <style>
        html.i18n-pending body {
            opacity: 0;
            pointer-events: none;
        }
    </style>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/typography.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/components/media-gallery.css">
    <link rel="stylesheet" href="../css/pages/lot.css">
    <link rel="stylesheet" href="../css/rtl.css">
    <link rel="stylesheet" href="../css/components/lang-toggle.css">
</head>

<body>
    <div id="site-header"></div>

    <main class="section">
        <div class="container">
            <div class="lot-layout" id="lot-content">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Bid Modal -->
    <div class="modal-backdrop" id="bid-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="bidModal.placeBid">Place Bid</h3>
                <button class="modal-close" data-close-modal>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-muted mb-4" id="bid-lot-title"></p>
                <div class="bid-info mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm" data-i18n="bidModal.currentBid">Current Bid:</span>
                        <span class="text-sm font-semibold" id="bid-current-bid"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm" data-i18n="bidModal.minimumBid">Minimum Bid:</span>
                        <span class="text-sm font-semibold text-accent" id="bid-min-bid"></span>
                    </div>
                </div>
                <form id="bid-form">
                    <div class="form-group">
                        <label class="form-label" data-i18n="bidModal.yourBid">Your Bid</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" class="form-input" id="bid-amount" required style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="incrementBid()"
                                style="padding: 0.75rem 1rem;">+</button>
                        </div>
                        <p class="text-xs text-muted" style="margin-top: 0.5rem;"><span
                                data-i18n="bidModal.bidIncrement">Increment:</span> <span
                                id="bid-increment-label">$100</span></p>
                    </div>
                    <div id="bid-error" class="form-error" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close-modal data-i18n="bidModal.cancel">Cancel</button>
                <button class="btn btn-primary"
                    onclick="document.getElementById('bid-form').dispatchEvent(new Event('submit'))"
                    data-i18n="bidModal.placeBid">Place Bid</button>
            </div>
        </div>
    </div>

    <!-- Bid Confirmation Modal -->
    <div class="modal-backdrop" id="bid-confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="bidModal.placeBid">Place Bid</h3>
                <button class="modal-close" id="bid-confirm-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm" id="confirm-bid-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirm-bid-cancel" data-i18n="bidModal.cancel">Cancel</button>
                <button class="btn btn-primary" id="confirm-bid-submit" data-i18n="bidModal.placeBid">Place Bid</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-backdrop" id="bid-success-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="bidModal.bidSuccess">Bid Placed Successfully!</h3>
                <button class="modal-close" data-close-modal>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-muted mb-4" id="success-lot-title"></p>
                <div class="success-summary">
                    <div class="flex justify-between mb-3">
                        <span data-i18n="bidModal.yourBid">Your Bid:</span>
                        <span class="font-semibold" id="success-bid-amount"></span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-sm"><span data-i18n="auction.buyersPremium">Buyer's Premium</span> (<span
                                id="success-premium-percent">25</span>%):</span>
                        <span class="text-sm" id="success-buyers-premium"></span>
                    </div>
                    <div class="flex justify-between pt-3" style="border-top: 1px solid var(--color-border);">
                        <span class="font-semibold" data-i18n="bidModal.totalIfWin">Total if you win:</span>
                        <span class="font-semibold text-accent" id="success-total"></span>
                    </div>
                </div>
                <p class="text-sm text-muted mt-6" data-i18n="bidModal.highestBidder">You are currently the highest
                    bidder. You'll be notified if you're
                    outbid.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-full" data-close-modal data-i18n="bidModal.close">Close</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p data-i18n="footer.copyright">&copy; 2026 TURATHYA. All rights reserved.</p>
            </div>
        </div>
    </footer>
    <script src="../js/i18n.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/media-gallery.js"></script>
    <script src="../js/countdown.js"></script>
    <script src="../js/watchlist.js"></script>
    <script src="../js/bidding.js"></script>
    <script>
        const lotId = getUrlParameter('id');

        function refreshLotData() {
            loadLot();
        }

        async function loadLot() {
            try {
                const { lot } = await lotsAPI.getById(lotId);

                if (!lot) {
                    window.location.href = 'auctions.html';
                    return;
                }

                document.getElementById('page-title').textContent = lot.title + ' - TURATHYA';

                const isClosed = hasEnded(lot.end_date) || lot.status !== 'active';
                const currentUser = getCurrentUser();
                const isUserWinning = currentUser && lot.highest_bidder_id === currentUser.id;

                let bidButtonHtml;
                if (isClosed) {
                    bidButtonHtml = '<button class="btn btn-secondary btn-lg w-full mb-6" disabled>' + i18n.t('auction.biddingClosed') + '</button>';
                } else if (isUserWinning) {
                    bidButtonHtml = '<button class="btn btn-success btn-lg w-full mb-6" disabled style="cursor: default; opacity: 0.9;">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">' +
                        '<polyline points="20 6 9 17 4 12"></polyline>' +
                        '</svg>' +
                        (i18n.t('bidModal.alreadyWinning')) +
                        '</button>';
                } else {
                    bidButtonHtml = '<button class="btn btn-accent btn-lg w-full mb-6" onclick="showBidModal(\'' + lot.id + '\')">' + i18n.t('auction.placeBid') + '</button>';
                }

                const container = document.getElementById('lot-content');
                container.innerHTML =
                    '<div id="lot-media-gallery"></div>' +
                    '<div class="lot-details">' +
                    '<div class="lot-header">' +
                    '<div class="flex justify-between items-start mb-4">' +
                    '<div>' +
                    '<div class="label mb-2">Lot ' + lot.lot_number + ' â€¢ ' + (lot.category || i18n.t('categories.other')) + '</div>' +
                    '<h1 class="lot-title">' + lot.title + '</h1>' +
                    '</div>' +
                    '<button class="watchlist-btn" data-watchlist-lot="' + lot.id + '" title="' + i18n.t('auction.addToWatchlist') + '">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                    '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>' +
                    '</svg>' +
                    '</button>' +
                    '</div>' +
                    '<p class="text-sm text-muted mb-6">' +
                    '<a href="auction.html?id=' + lot.auction_id + '" class="text-accent">' + (lot.auction_title || i18n.t('nav.auctions')) + '</a>' +
                    '</p>' +
                    '</div>' +
                    '<div class="bid-section">' +
                    '<div class="current-bid">' +
                    '<span class="label">' + i18n.t('auction.currentBid') + '</span>' +
                    '<span class="price">' + (lot.current_bid && lot.current_bid > 0 ? formatCurrency(lot.current_bid) : formatCurrency(lot.starting_bid)) + '</span>' +
                    (lot.bid_count > 0 ? '<span class="text-sm text-muted">' + lot.bid_count + ' ' + (lot.bid_count !== 1 ? i18n.t('auction.bids') : i18n.t('auction.bid')) + '</span>' : '<span class="text-sm text-muted">' + i18n.t('auction.noBids') + '</span>') +
                    '</div>' +
                    '<div class="countdown-section">' +
                    '<span class="label">' + i18n.t('auction.timeRemaining') + '</span>' +
                    '<div data-countdown="' + lot.end_date + '"></div>' +
                    '</div>' +
                    '</div>' +
                    bidButtonHtml +
                    '<div class="info-section">' +
                    '<h3>' + i18n.t('auction.estimate') + '</h3>' +
                    '<p class="estimate">' + formatEstimate(lot.estimate_low, lot.estimate_high) + '</p>' +
                    '</div>' +
                    '<div class="info-section">' +
                    '<h3>' + i18n.t('auction.description') + '</h3>' +
                    '<p>' + (lot.description || i18n.t('auction.noDescription')) + '</p>' +
                    '</div>' +
                    '<div class="info-section">' +
                    '<h3>' + i18n.t('auction.condition') + '</h3>' +
                    '<p>' + (lot.condition || i18n.t('auction.notSpecified')) + '</p>' +
                    '</div>' +
                    (lot.provenance ? '<div class="info-section"><h3>' + i18n.t('auction.provenance') + '</h3><p>' + lot.provenance + '</p></div>' : '') +
                    '<div class="info-section">' +
                    '<h3>' + i18n.t('auction.shippingPickup') + '</h3>' +
                    '<p>' + (lot.shipping || i18n.t('auction.contactForShipping')) + '</p>' +
                    '</div>' +
                    '<div class="info-section">' +
                    '<h3>' + i18n.t('auction.buyersPremium') + '</h3>' +
                    '<p>' + (lot.buyers_premium || 25) + '% ' + i18n.t('auction.premiumAdded') + '</p>' +
                    '</div>' +
                    '</div>';

                initCountdowns();
                updateWatchlistButtons();

                const mediaItems = prepareMediaItems(lot);
                if (mediaItems.length > 0) {
                    initMediaGallery('lot-media-gallery', mediaItems);
                }
            } catch (error) {
                console.error('Failed to load lot:', error);
                alert('Failed to load lot details');
                window.location.href = 'auctions.html';
            }
        }

        function prepareMediaItems(lot) {
            const items = [];
            const fallbackCover = lot.image_data || lot.auction_image || '../assets/images/placeholder.png';

            // Prioritize lot_media table if it exists
            if (lot.media && lot.media.length > 0) {
                lot.media.forEach((media, index) => {
                    const mediaItem = {
                        type: media.media_type || 'image',
                        src: media.url,
                        alt: lot.title + ' - ' + (index + 1)
                    };

                    // Add poster/thumbnail for videos
                    if (media.media_type === 'video' && media.thumbnail_url) {
                        mediaItem.poster = media.thumbnail_url;
                    }

                    if (media.media_type === 'video') {
                        mediaItem.fallbackPoster = fallbackCover;
                    }

                    items.push(mediaItem);
                });
            } else {
                // Fallback to image_data or auction image
                const lotImage = lot.image_data || lot.auction_image;
                if (lotImage) {
                    items.push({
                        type: 'image',
                        src: lotImage,
                        alt: lot.title
                    });
                }
            }

            // Ultimate fallback to placeholder
            if (items.length === 0) {
                items.push({
                    type: 'image',
                    src: '../assets/images/placeholder.png',
                    alt: lot.title
                });
            }

            return items;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!lotId) {
                window.location.href = 'auctions.html';
                return;
            }

            loadLot();
        });

        // Reload lot content when language changes
        window.addEventListener('languageChanged', () => {
            loadLot();
        });
    </script>
</body>

</html>